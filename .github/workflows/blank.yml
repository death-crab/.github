# This is a basic workflow to help you get started with Actions

name: CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    env:
      package-file: packages.json
      commit-message: Update package info [bot]

    steps:
    - name: Get app token
      uses: actions/create-github-app-token@v1.11.0
      id: get-app-token
      with:
        app-id: ${{ vars.PACKAGE_READER_APP_ID }}
        private-key: ${{ secrets.PACKAGE_READER_APP_KEY }}
        owner: ${{ github.repository_owner }}

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Generate Package Info
      env:
        NuGetPackageSourceCredentials_death-crab: Username=github;Password=${{ steps.get-app-token.outputs.token }}
      run: |
        cd status
        dotnet package search --source death-crab --format json > ${{ env.package-file }}

    - name: Push Package Info to Public Repo
      run: |
        git_username=${{ steps.get-app-token.outputs.app-slug }}[bot]
        git config user.name $git_username
        git config user.email $git_username@users.noreply.github.com
        
        git add ${{ env.package-file }}
        git commit -m ${{ env.commit-message }}
        git push
